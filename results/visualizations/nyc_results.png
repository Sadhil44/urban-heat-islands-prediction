// AOI
var aoi = ee.Geometry.Polygon(
    [[[-74.6000, 41.0000], // Top-left corner
      [-74.6000, 40.4000], // Bottom-left corner
      [-73.7000, 40.4000], // Bottom-right corner
      [-73.7000, 41.0000]]] // Top-right corner
);

var clippedAoi = ee.Geometry.Polygon(
    [[[-74.6000, 41.0000], // Top-left corner
      [-74.6000, 40.4000], // Bottom-left corner
      [-73.7000, 40.4000], // Bottom-right corner
      [-73.7000, 41.0000]]] // Top-right corner
);

var predictionAoi = ee.Geometry.Polygon(
    [[[-74.6000, 41.0000], // Top-left corner
      [-74.6000, 40.4000], // Bottom-left corner
      [-73.7000, 40.4000], // Bottom-right corner
      [-73.7000, 41.0000]]] // Top-right corner
);

var startDate = '2022-05-01'
var endDate = '2022-12-31'

// *****************************************************************************************

// Applies scaling factors.
function applyScaleFactors(image) {
var opticalBands = image.select('SR_B.').multiply(0.0000275).add(-0.2);
var thermalBands = image.select('ST_B.*').multiply(0.00341802).add(149.0);
return image.addBands(opticalBands, null, true)
          .addBands(thermalBands, null, true);
}

//cloud mask
function maskL8sr(col) {
// Bits 3 and 5 are cloud shadow and cloud, respectively.
var cloudShadowBitMask = (1 << 3);
var cloudsBitMask = (1 << 5);
// Get the pixel QA band.
var qa = col.select('QA_PIXEL');
// Both flags should be set to zero, indicating clear conditions.
var mask = qa.bitwiseAnd(cloudShadowBitMask).eq(0)
             .and(qa.bitwiseAnd(cloudsBitMask).eq(0));
return col.updateMask(mask);
}

// Filter the collection, first by the aoi, and then by date.
var image = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
.filterDate(startDate, endDate)
.filterBounds(aoi)
.map(applyScaleFactors)
.map(maskL8sr)
.median();

var visualization = {
bands: ['SR_B4', 'SR_B3', 'SR_B2'],
min: 0.0,
max: 0.3,
};

Map.addLayer(image, visualization, 'True Color (432)', false);

// NDVI
var ndvi  = image.normalizedDifference(['SR_B5', 'SR_B4']).rename('NDVI')
Map.addLayer(ndvi, {min:-1, max:1, palette: ['blue', 'white', 'green']}, 'ndvi', false)

// ndvi statistics
var ndvi_min = ee.Number(ndvi.reduceRegion({
reducer: ee.Reducer.min(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))

var ndvi_max = ee.Number(ndvi.reduceRegion({
reducer: ee.Reducer.max(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


// fraction of veg
var fv = (ndvi.subtract(ndvi_min).divide(ndvi_max.subtract(ndvi_min))).pow(ee.Number(2))
      .rename('FV')


var em = fv.multiply(ee.Number(0.004)).add(ee.Number(0.986)).rename('EM')

var thermal = image.select('ST_B10').rename('thermal')

// This code addresses GitHub Issue #1: Incorrect LST formula parameters
// Corrected λ to 11.5 μm and ρ to 14380 μm·K for consistent units.

var lst = thermal.expression(
    '(tb / (1 + ((11.5 * (tb / 14380)) * log(em)))) - 273.15',
    {
        'tb': thermal.select('thermal'), // Brightness temperature in Kelvin
        'em': em                        // Emissivity
    }
).rename('LST');



var lst_vis = {
min: 7,
max: 50,
palette: [
'040274', '040281', '0502a3', '0502b8', '0502ce', '0502e6',
'0602ff', '235cb1', '307ef3', '269db1', '30c8e2', '32d3ef',
'3be285', '3ff38f', '86e26f', '3ae237', 'b5e22e', 'd6e21f',
'fff705', 'ffd611', 'ffb613', 'ff8b13', 'ff6e08', 'ff500d',
'ff0000', 'de0101', 'c21301', 'a71001', '911003']
}

var clippedLST = lst.clip(clippedAoi);

Export.image.toDrive({
  image: clippedLST,
  description: 'True LST',
  scale: 30
})

Map.addLayer(clippedLST, lst_vis, 'LST AOI')
Map.centerObject(clippedAoi, 10)

// Urban Heat Island ***********************************************************************

//1. Normalized UHI

var lst_mean = ee.Number(lst.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var lst_std = ee.Number(lst.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))



print('Mean LST in AOI', lst_mean)
print('STD LST in AOI', lst_std)


var uhi = lst.subtract(lst_mean).divide(lst_std).rename('UHI')

var uhi_vis = {
min: -4,
max: 4,
palette:['313695', '74add1', 'fed976', 'feb24c', 'fd8d3c', 'fc4e2a', 'e31a1c',
'b10026']
}

var uhi_mean = ee.Number(uhi.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var uhi_std = ee.Number(uhi.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))

print('Mean UHI in AOI', uhi_mean)
print('STD UHI in AOI', uhi_std)

var clippedUHI = uhi.clip(clippedAoi);
Map.addLayer(clippedUHI, uhi_vis, 'UHI AOI')

var utfvi = lst.subtract(lst_mean).divide(lst).rename('UTFVI')
var utfvi_vis = {
min: -1,
max: 0.3,
palette:['313695', '74add1', 'fed976', 'feb24c', 'fd8d3c', 'fc4e2a', 'e31a1c',
'b10026']
}

var utfvi_mean = ee.Number(utfvi.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var utfvi_std = ee.Number(utfvi.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))

print('Mean UTFVI in AOI', utfvi_mean)
print('STD UTFVI in AOI', utfvi_std)


var clippedUTFVI = utfvi.clip(clippedAoi);

Map.addLayer(clippedUTFVI, utfvi_vis, 'UTFVI AOI')


// Extract the necessary bands from the original image
var imageWithFeatures = image.addBands([ndvi, em]);  // Add NDVI and EM as features

// ****************************************************************************************
// Calculate UHI (Normalized Urban Heat Island) for the original AOI
var lst_mean = ee.Number(lst.reduceRegion({
  reducer: ee.Reducer.mean(),
  geometry: aoi,
  scale: 30,
  maxPixels: 1e9
}).get('LST'));

var lst_std = ee.Number(lst.reduceRegion({
  reducer: ee.Reducer.stdDev(),
  geometry: aoi,
  scale: 30,
  maxPixels: 1e9
}).get('LST'));

// Load 2017 Landsat 8 Image and Compute NDVI & Emissivity (EM)
var image2017 = ee.ImageCollection('LANDSAT/LC08/C02/T1_TOA')
  .filterBounds(aoi)
  .filterDate('2017-06-01', '2017-08-31')
  .median()
  .clip(aoi);

var ndvi2017 = image2017.normalizedDifference(['B5', 'B4']).rename('NDVI');
var em2017 = image2017.select('B10').multiply(0.004).add(0.986).rename('EM');


// Prepare the dataset for regression
var predictors = image2017.addBands([ndvi2017, em2017]).select(['NDVI', 'EM']);
var response = lst;

// Sample the data
var sample = predictors.addBands(response).sample({
  region: aoi,
  scale: 30,
  numPixels: 10000,
  seed: 0
});

// Split the sample into training and testing datasets
var sampleRandom = sample.randomColumn('random', 0);
var trainingSample = sampleRandom.filter(ee.Filter.lte('random', 0.7));
var testingSample = sampleRandom.filter(ee.Filter.gt('random', 0.7));

// Train the Random Forest regressor
var rfRegressor = ee.Classifier.smileRandomForest(100).setOutputMode('REGRESSION').train({
  features: trainingSample,
  classProperty: 'LST',
  inputProperties: predictors.bandNames()
});

// Apply the regressor to the predictors
var predictedLST2022 = predictors.classify(rfRegressor).rename('Predicted_LST');

// Evaluate the regression model
var testingSampleWithPredictions = testingSample.classify(rfRegressor).select(['LST', 'classification'], ['LST', 'Predicted_LST']);
var lstPredicted_vis = {
min: 7,
max: 50,
palette: [
'040274', '040281', '0502a3', '0502b8', '0502ce', '0502e6',
'0602ff', '235cb1', '307ef3', '269db1', '30c8e2', '32d3ef',
'3be285', '3ff38f', '86e26f', '3ae237', 'b5e22e', 'd6e21f',
'fff705', 'ffd611', 'ffb613', 'ff8b13', 'ff6e08', 'ff500d',
'ff0000', 'de0101', 'c21301', 'a71001', '911003']
}

var predictedlst_mean = ee.Number(predictedLST2022.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var predictedlst_std = ee.Number(predictedLST2022.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))



print('Predicted Mean LST in AOI for RFR', predictedlst_mean)
print('Predicted STD LST in AOI for RFR', predictedlst_std)

Map.addLayer(predictedLST2022, lstPredicted_vis, 'LST AOI')
Map.centerObject(aoi, 10)

// Urban Heat Island ***********************************************************************

//1. Normalized UHI

var lst_mean = ee.Number(predictedLST2022.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var lst_std = ee.Number(predictedLST2022.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))



print('Mean LST in AOI', lst_mean)
print('STD LST in AOI', lst_std)


var uhi = predictedLST2022.subtract(lst_mean).divide(lst_std).rename('UHI')

var uhi_vis = {
min: -4,
max: 4,
palette:['313695', '74add1', 'fed976', 'feb24c', 'fd8d3c', 'fc4e2a', 'e31a1c',
'b10026']
}

var uhi_mean = ee.Number(uhi.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var uhi_std = ee.Number(uhi.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))

print('Mean UHI in AOI', uhi_mean)
print('STD UHI in AOI', uhi_std)

var clippedUHI = uhi.clip(clippedAoi);
Map.addLayer(clippedUHI, uhi_vis, 'UHI AOI for RFR')

var utfvi = predictedLST2022.subtract(lst_mean).divide(lst).rename('UTFVI')
var utfvi_vis = {
min: -1,
max: 0.3,
palette:['313695', '74add1', 'fed976', 'feb24c', 'fd8d3c', 'fc4e2a', 'e31a1c',
'b10026']
}

var utfvi_mean = ee.Number(utfvi.reduceRegion({
reducer: ee.Reducer.mean(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))


var utfvi_std = ee.Number(utfvi.reduceRegion({
reducer: ee.Reducer.stdDev(),
geometry: aoi,
scale: 30,
maxPixels: 1e9
}).values().get(0))

print('Mean UTFVI in AOI', utfvi_mean)
print('STD UTFVI in AOI', utfvi_std)

// Percentage of critical/dangerous UTFVI areas (>0.05)

var clippedUTFVI = utfvi.clip(clippedAoi);

var totalArea = ee.Number(ee.Image.pixelArea().reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: aoi,
  scale: 30,
  maxPixels: 1e9
}).get('area'));

var criticalUTFVI = clippedUTFVI.gt(0.05); // Mask for critical conditions

var areaCriticalUTFVI = criticalUTFVI.multiply(ee.Image.pixelArea()).reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: aoi,
  scale: 30,
  maxPixels: 1e9
}).get('UTFVI');

var criticalUTFVIpercentage = ee.Number(areaCriticalUTFVI).divide(totalArea).multiply(100);
print('Percentage of Critical/Dangerous UTFVI Areas (>0.05):', criticalUTFVIpercentage);

Map.addLayer(clippedUTFVI, utfvi_vis, 'UTFVI AOI for RFR')

